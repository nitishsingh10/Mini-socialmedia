<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeUp</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <a href="index.html" class="sidebar-logo">
                <i class="fas fa-bolt"></i>
                <span>VibeUp</span>
            </a>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item active">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="discover.html" class="nav-item">
                    <i class="fas fa-compass"></i>
                    <span>Discover</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info" onclick="window.location.href='profile.html'">
                    <img id="sidebarAvatar" src="" class="user-avatar" alt="">
                    <div class="user-details">
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-handle" id="sidebarHandle">@loading</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-area">
            <div class="feed-container">
                <!-- Stories Section -->
                <div class="stories-section" id="storiesRow">
                    <div class="story add-story">
                        <div class="story-ring">
                            <i class="fas fa-plus"></i>
                        </div>
                        <span class="story-name">Add</span>
                    </div>
                    <!-- Dynamic stories will be inserted here -->
                </div>

                <div class="post-composer">
                    <textarea id="postInput" class="composer-input" placeholder="What's happening?"></textarea>

                    <div id="feelingIndicator" class="feeling-indicator hidden">
                        <span id="feelingEmoji"></span>
                        <span id="feelingText"></span>
                        <button class="feeling-remove" onclick="removeFeeling()">√ó</button>
                    </div>

                    <div id="imagePreview" class="image-preview">
                        <img id="previewImg" src="">
                        <button onclick="removeImage()">√ó</button>
                    </div>

                    <div id="feelingPicker" class="feeling-picker hidden">
                        <div class="feeling-picker-title">How are you feeling?</div>
                        <div class="feeling-grid">
                            <button class="feeling-btn" onclick="selectFeeling('üòä', 'happy')">üòä Happy</button>
                            <button class="feeling-btn" onclick="selectFeeling('üòç', 'loved')">üòç Loved</button>
                            <button class="feeling-btn" onclick="selectFeeling('üéâ', 'excited')">üéâ Excited</button>
                            <button class="feeling-btn" onclick="selectFeeling('üòé', 'cool')">üòé Cool</button>
                            <button class="feeling-btn" onclick="selectFeeling('ü§î', 'thoughtful')">ü§î Thinking</button>
                            <button class="feeling-btn" onclick="selectFeeling('üò¥', 'tired')">üò¥ Tired</button>
                            <button class="feeling-btn" onclick="selectFeeling('üí™', 'motivated')">üí™ Motivated</button>
                            <button class="feeling-btn" onclick="selectFeeling('‚òï', 'relaxed')">‚òï Relaxed</button>
                        </div>
                    </div>

                    <div class="composer-actions">
                        <div class="composer-tools">
                            <input type="file" id="imageInput" accept="image/*" hidden
                                onchange="handleImageUpload(event)">
                            <button class="tool-btn" onclick="document.getElementById('imageInput').click()">
                                <i class="fas fa-image"></i>
                                <span>Image</span>
                            </button>
                            <button class="tool-btn" onclick="toggleFeelingPicker()">
                                <i class="fas fa-smile"></i>
                                <span>Feeling</span>
                            </button>
                        </div>
                        <button class="btn-primary" onclick="createPost()">Post</button>
                    </div>
                </div>

                <!-- Feed -->
                <div id="feedContainer"></div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state hidden">
                    <i class="fas fa-stream"></i>
                    <h3>No posts yet</h3>
                    <p>Create your first post or follow people to see updates</p>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <div class="widget">
                <div class="widget-title">
                    <i class="fas fa-fire"></i>
                    Trending
                </div>
                <div class="trending-item">
                    <span class="trending-rank">1</span>
                    <div class="trending-info">
                        <div class="trending-topic">#TechVibes</div>
                        <div class="trending-count">2.4k posts</div>
                    </div>
                </div>
                <div class="trending-item">
                    <span class="trending-rank">2</span>
                    <div class="trending-info">
                        <div class="trending-topic">#BuildInPublic</div>
                        <div class="trending-count">1.8k posts</div>
                    </div>
                </div>
                <div class="trending-item">
                    <span class="trending-rank">3</span>
                    <div class="trending-info">
                        <div class="trending-topic">#Hackathon</div>
                        <div class="trending-count">1.2k posts</div>
                    </div>
                </div>
            </div>

            <div class="widget">
                <div class="widget-title">
                    <i class="fas fa-bolt"></i>
                    Quick Stats
                </div>
                <div style="display: flex; gap: 16px;">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPosts">0</div>
                        <div class="stat-label">Posts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalLikes">0</div>
                        <div class="stat-label">Likes</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="index.html" class="nav-item active"><i class="fas fa-home"></i></a>
        <a href="discover.html" class="nav-item"><i class="fas fa-compass"></i></a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user"></i></a>
        <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i></a>
    </nav>

    <!-- Story Viewer Modal -->
    <div id="storyViewer" class="story-viewer hidden">
        <div class="story-backdrop" onclick="closeStoryViewer()"></div>
        <div class="story-content-wrapper">
            <!-- Progress Bar -->
            <div class="story-progress-container" id="storyProgressBars">
                <!-- Bars will be injected here -->
            </div>

            <!-- Header -->
            <div class="story-header">
                <div class="story-user-info">
                    <img id="storyViewerAvatar" src="" alt="">
                    <span id="storyViewerName">Author Name</span>
                    <span id="storyViewerTime">2h</span>
                </div>
                <div class="story-actions">
                    <button class="story-close-btn" onclick="closeStoryViewer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Media -->
            <div class="story-media-container">
                <!-- Image or Video will be injected here -->
                <div id="storyMediaPlaceHolder" class="story-media-placeholder">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Navigation Overlays -->
            <div class="story-nav-prev" onclick="prevStory()"></div>
            <div class="story-nav-next" onclick="nextStory()"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="js/app.js"></script>
    <script>
        let selectedImage = null;
        let selectedFeeling = null;

        document.addEventListener('DOMContentLoaded', () => {
            initializeDummyPosts();
            loadFeed();
            loadUserInfo();
            loadStats();
        });

        function initializeDummyPosts() {
            const posts = getPosts();

            const dummyPosts = [
                {
                    id: 'dummy_pixelweb',
                    text: 'Persistant Local Storage ‚úÖ',
                    image: 'images/pixelweb_post.png',
                    feeling: { emoji: 'ü§ñ', text: 'by authors' },
                    authorId: 'user_pixelweb',
                    authorName: 'PixelWEB',
                    authorAvatar: 'https://ui-avatars.com/api/?name=Pixel+WEB&background=673AB7&color=fff',
                    likes: 999,
                    likedBy: [],
                    comments: [],
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'dummy_1',
                    text: "Just finished my first marathon! üèÉ‚Äç‚ôÇÔ∏èüí® The energy was incredible. Can't wait for the next one! #Running #FitnessGoals",
                    image: 'images/marathon.png',
                    feeling: { emoji: 'üéâ', text: 'excited' },
                    authorId: 'user_alex',
                    authorName: 'Alex Rivera',
                    authorAvatar: 'https://ui-avatars.com/api/?name=Alex+Rivera&background=0D8ABC&color=fff',
                    likes: 42,
                    likedBy: [],
                    comments: [
                        {
                            id: 'c1',
                            text: 'Way to go Alex! üí™',
                            authorName: 'Sarah Chen',
                            authorAvatar: 'https://ui-avatars.com/api/?name=Sarah+Chen&background=E91E63&color=fff',
                            createdAt: new Date(Date.now() - 3600000).toISOString()
                        }
                    ],
                    createdAt: new Date(Date.now() - 7200000).toISOString()
                },
                {
                    id: 'dummy_2',
                    text: "Exploring the beautiful streets of Kyoto. The cherry blossoms are breathtaking this time of year. üå∏üèØ",
                    image: 'images/image.png',
                    feeling: { emoji: 'üòç', text: 'loved' },
                    authorId: 'user_sarah',
                    authorName: 'Sarah Chen',
                    authorAvatar: 'https://ui-avatars.com/api/?name=Sarah+Chen&background=E91E63&color=fff',
                    likes: 89,
                    likedBy: [],
                    comments: [],
                    createdAt: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'dummy_3',
                    text: "Coding late into the night. Coffee is my best friend right now. ‚òïüíª Does anyone else love the peace of night coding? #DeveloperLife",
                    image: 'images/coffee.png',
                    feeling: { emoji: '‚òï', text: 'relaxed' },
                    authorId: 'user_mike',
                    authorName: 'Mike Johnson',
                    authorAvatar: 'https://ui-avatars.com/api/?name=Mike+Johnson&background=FF9800&color=fff',
                    likes: 24,
                    likedBy: [],
                    comments: [],
                    createdAt: new Date(Date.now() - 172800000).toISOString()
                }
            ];

            let postsChanged = false;

            dummyPosts.forEach(dummy => {
                const index = posts.findIndex(p => p.id === dummy.id);
                if (index === -1) {
                    // Add new dummy post
                    posts.unshift(dummy);
                    postsChanged = true;
                } else {
                    // Update existing dummy post content (image, text, etc)
                    // This ensures changes to dummy posts are reflected even if they are already in LS
                    if (posts[index].image !== dummy.image ||
                        posts[index].text !== dummy.text ||
                        JSON.stringify(posts[index].feeling) !== JSON.stringify(dummy.feeling)) {

                        posts[index].image = dummy.image;
                        posts[index].text = dummy.text;
                        posts[index].feeling = dummy.feeling;
                        postsChanged = true;
                    }
                }
            });

            if (postsChanged) {
                savePosts(posts);
                // Reload feed to show changes immediately if we are initializing
                const container = document.getElementById('feedContainer');
                if (container) container.innerHTML = ''; // Force reload trigger if needed, though loadFeed called after will handle it
            }
        }

        function loadUserInfo() {
            const user = getUser();
            const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=171717&color=ededed`;
            document.getElementById('sidebarAvatar').src = avatar;
            document.getElementById('sidebarName').textContent = user.name;
            document.getElementById('sidebarHandle').textContent = '@' + user.username;
        }

        function loadStats() {
            const posts = getPosts();
            const user = getUser();
            const userPosts = posts.filter(p => p.authorId === user.id);
            document.getElementById('totalPosts').textContent = userPosts.length;
            document.getElementById('totalLikes').textContent = userPosts.reduce((a, b) => a + (b.likes || 0), 0);
        }

        function toggleFeelingPicker() {
            document.getElementById('feelingPicker').classList.toggle('hidden');
        }

        function selectFeeling(emoji, text) {
            selectedFeeling = { emoji, text };
            document.getElementById('feelingEmoji').textContent = emoji;
            document.getElementById('feelingText').textContent = text;
            document.getElementById('feelingIndicator').classList.remove('hidden');
            document.getElementById('feelingPicker').classList.add('hidden');
        }

        function removeFeeling() {
            selectedFeeling = null;
            document.getElementById('feelingIndicator').classList.add('hidden');
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImage = e.target.result;
                    document.getElementById('previewImg').src = selectedImage;
                    document.getElementById('imagePreview').classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            selectedImage = null;
            document.getElementById('imagePreview').classList.remove('active');
            document.getElementById('imageInput').value = '';
        }

        function createPost() {
            const text = document.getElementById('postInput').value.trim();

            if (!text && !selectedImage && !selectedFeeling) {
                showToast('Write something to post', 'error');
                return;
            }

            const user = getUser();
            const newPost = {
                id: Date.now().toString(),
                text,
                image: selectedImage,
                feeling: selectedFeeling,
                authorId: user.id,
                authorName: user.name,
                authorAvatar: user.avatar,
                likes: 0,
                likedBy: [],
                comments: [],
                createdAt: new Date().toISOString()
            };

            const posts = getPosts();
            posts.unshift(newPost);
            savePosts(posts);

            // Clear form
            document.getElementById('postInput').value = '';
            removeImage();
            removeFeeling();

            loadFeed();
            loadStats();
            showToast('Posted');
        }

        function loadFeed() {
            const posts = getPosts();
            const container = document.getElementById('feedContainer');
            const empty = document.getElementById('emptyState');
            const user = getUser();

            if (posts.length === 0) {
                empty.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = posts.map(post => {
                const comments = post.comments || [];
                const likedByUser = post.likedBy && post.likedBy.includes(user.id);
                const timeAgo = getTimeAgo(post.createdAt);
                const feelingBadge = post.feeling ?
                    `<span class="feeling-badge">¬∑ ${post.feeling.emoji} ${post.feeling.text}</span>` : '';
                const avatar = post.authorAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(post.authorName)}&background=171717&color=ededed`;

                return `
                    <article class="post-item" data-id="${post.id}">
                        <div class="post-header">
                            <img src="${avatar}" class="post-avatar" alt="">
                            <div class="post-meta">
                                <div class="post-author">
                                    ${post.authorName}
                                    <span class="post-handle">@${post.authorName.toLowerCase().replace(/\s/g, '')}</span>
                                    ${feelingBadge}
                                </div>
                                <div class="post-time">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="post-content">
                            ${post.text ? `<p class="post-text">${post.text}</p>` : ''}
                            ${post.image ? `<div class="post-image"><img src="${post.image}" alt=""></div>` : ''}
                        </div>
                        <div class="post-actions">
                            <button class="action-btn ${likedByUser ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                                <i class="fas fa-heart"></i>
                                <span>${post.likes || 0}</span>
                            </button>
                            <button class="action-btn" onclick="toggleComments('${post.id}')">
                                <i class="fas fa-comment"></i>
                                <span>${comments.length}</span>
                            </button>
                        </div>
                        <div id="comments-${post.id}" class="comments-section hidden">
                            ${comments.map(c => `
                                <div class="comment-item">
                                    <img src="${c.authorAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.authorName)}&background=171717&color=ededed`}" class="comment-avatar" alt="">
                                    <div class="comment-body">
                                        <span class="comment-author">${c.authorName}</span>
                                        <span class="comment-text">${c.text}</span>
                                    </div>
                                </div>
                            `).join('')}
                            <div class="comment-input-row">
                                <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment...">
                                <button class="btn-primary" onclick="addComment('${post.id}')">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function toggleComments(postId) {
            document.getElementById('comments-' + postId).classList.toggle('hidden');
        }

        function addComment(postId) {
            const input = document.getElementById('comment-input-' + postId);
            const text = input.value.trim();
            if (!text) return;

            const user = getUser();
            const posts = getPosts();
            const postIndex = posts.findIndex(p => p.id === postId);
            if (postIndex === -1) return;

            if (!posts[postIndex].comments) posts[postIndex].comments = [];

            posts[postIndex].comments.push({
                id: Date.now().toString(),
                text,
                authorId: user.id,
                authorName: user.name,
                authorAvatar: user.avatar,
                createdAt: new Date().toISOString()
            });

            savePosts(posts);
            loadFeed();

            setTimeout(() => {
                document.getElementById('comments-' + postId).classList.remove('hidden');
            }, 50);
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
            return date.toLocaleDateString();
        }
    </script>
</body>

</html>