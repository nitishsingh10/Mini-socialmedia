<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - VibeUp</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="index.html" class="sidebar-logo">
                <i class="fas fa-bolt"></i>
                <span>VibeUp</span>
            </a>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
                <a href="discover.html" class="nav-item"><i class="fas fa-compass"></i><span>Discover</span></a>
                <a href="profile.html" class="nav-item active"><i class="fas fa-user"></i><span>Profile</span></a>
                <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" onclick="window.location.href='profile.html'">
                    <img id="sidebarAvatar" class="user-avatar" src="" alt="">
                    <div class="user-details">
                        <div class="user-name" id="sidebarName">Loading...</div>
                        <div class="user-handle" id="sidebarHandle">@loading</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <div class="feed-container">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-info">
                        <div style="position: relative;">
                            <img id="profileAvatar" class="profile-avatar" src="" alt="">
                            <input type="file" id="avatarInput" accept="image/*" hidden
                                onchange="handleAvatarUpload(event)">
                        </div>
                        <div class="profile-details">
                            <h1 class="profile-name" id="profileName">Loading...</h1>
                            <p class="profile-handle" id="profileHandle">@loading</p>
                            <p class="profile-bio" id="profileBio">...</p>
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-value" id="postCount">0</span>
                                    <span class="stat-label">Posts</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="likesCount">0</span>
                                    <span class="stat-label">Likes</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">0</span>
                                    <span class="stat-label">Followers</span>
                                </div>
                            </div>
                            <div class="profile-actions">
                                <button class="btn-primary" onclick="openEditModal()">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="tool-btn" onclick="document.getElementById('avatarInput').click()">
                                    <i class="fas fa-camera"></i> Avatar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Post -->
                <div class="post-composer">
                    <textarea id="postInput" class="composer-input" placeholder="Share something..."></textarea>
                    <div id="imagePreview" class="image-preview">
                        <img id="previewImg" src="">
                        <button onclick="removeImage()">×</button>
                    </div>
                    <div class="composer-actions">
                        <div class="composer-tools">
                            <input type="file" id="imageInput" accept="image/*" hidden
                                onchange="handleImageUpload(event)">
                            <button class="tool-btn" onclick="document.getElementById('imageInput').click()">
                                <i class="fas fa-image"></i> Image
                            </button>
                        </div>
                        <button class="btn-primary" onclick="createPost()">Post</button>
                    </div>
                </div>

                <!-- User Posts -->
                <div id="userPosts"></div>
                <div id="emptyState" class="empty-state hidden">
                    <i class="fas fa-camera"></i>
                    <h3>No posts yet</h3>
                    <p>Create your first post</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="editName" class="form-input" placeholder="Your name">
            </div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="editUsername" class="form-input" placeholder="username">
            </div>
            <div class="form-group">
                <label class="form-label">Bio</label>
                <input type="text" id="editBio" class="form-input" placeholder="Tell us about yourself">
            </div>
            <div class="modal-footer">
                <button class="tool-btn" onclick="closeEditModal()">Cancel</button>
                <button class="btn-primary" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <!-- Mobile Nav -->
    <nav class="mobile-nav">
        <a href="index.html" class="nav-item"><i class="fas fa-home"></i></a>
        <a href="discover.html" class="nav-item"><i class="fas fa-compass"></i></a>
        <a href="profile.html" class="nav-item active"><i class="fas fa-user"></i></a>
        <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i></a>
    </nav>

    <div id="toastContainer" class="toast-container"></div>

    <script src="js/app.js"></script>
    <script>
        let selectedImage = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            loadUserPosts();
            loadSidebarInfo();
        });

        function loadSidebarInfo() {
            const user = getUser();
            const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=171717&color=ededed`;
            document.getElementById('sidebarAvatar').src = avatar;
            document.getElementById('sidebarName').textContent = user.name;
            document.getElementById('sidebarHandle').textContent = '@' + user.username;
        }

        function loadProfile() {
            const user = getUser();
            const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=171717&color=ededed`;
            document.getElementById('profileAvatar').src = avatar;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileHandle').textContent = '@' + user.username;
            document.getElementById('profileBio').textContent = user.bio || 'No bio yet';

            const posts = getPosts().filter(p => p.authorId === user.id);
            document.getElementById('postCount').textContent = posts.length;
            document.getElementById('likesCount').textContent = posts.reduce((a, b) => a + (b.likes || 0), 0);
        }

        function loadUserPosts() {
            const user = getUser();
            const posts = getPosts().filter(p => p.authorId === user.id);
            const container = document.getElementById('userPosts');
            const empty = document.getElementById('emptyState');

            if (posts.length === 0) {
                empty.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            empty.classList.add('hidden');
            const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=171717&color=ededed`;

            container.innerHTML = posts.map(post => `
                <article class="post-item">
                    <div class="post-header">
                        <img src="${avatar}" class="post-avatar" alt="">
                        <div class="post-meta">
                            <div class="post-author">${user.name}</div>
                            <div class="post-time">${new Date(post.createdAt).toLocaleDateString()}</div>
                        </div>
                        <button class="action-btn text-error" onclick="deletePost('${post.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="post-content">
                        ${post.text ? `<p class="post-text">${post.text}</p>` : ''}
                        ${post.image ? `<div class="post-image"><img src="${post.image}"></div>` : ''}
                    </div>
                    <div class="post-actions">
                        <button class="action-btn ${post.likedBy?.includes(user.id) ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                            <i class="fas fa-heart"></i> ${post.likes || 0}
                        </button>
                        <button class="action-btn" onclick="toggleComments('${post.id}')">
                            <i class="fas fa-comment"></i> ${(post.comments || []).length}
                        </button>
                    </div>
                    <div id="comments-${post.id}" class="comments-section hidden">
                        ${(post.comments || []).map(c => `
                            <div class="comment-item">
                                <img src="${c.authorAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.authorName)}&background=171717&color=ededed`}" class="comment-avatar">
                                <div class="comment-body">
                                    <span class="comment-author">${c.authorName}</span>
                                    <span class="comment-text">${c.text}</span>
                                </div>
                            </div>
                        `).join('')}
                        <div class="comment-input-row">
                            <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Comment...">
                            <button class="btn-primary" onclick="addComment('${post.id}')"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </article>
            `).join('');
        }

        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const user = getUser();
                    user.avatar = e.target.result;
                    saveUser(user);
                    loadProfile();
                    loadSidebarInfo();
                    showToast('Avatar updated');
                };
                reader.readAsDataURL(file);
            }
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImage = e.target.result;
                    document.getElementById('previewImg').src = selectedImage;
                    document.getElementById('imagePreview').classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            selectedImage = null;
            document.getElementById('imagePreview').classList.remove('active');
        }

        function createPost() {
            const text = document.getElementById('postInput').value.trim();
            if (!text && !selectedImage) {
                showToast('Add content to post', 'error');
                return;
            }

            const user = getUser();
            const posts = getPosts();
            posts.unshift({
                id: Date.now().toString(),
                text,
                image: selectedImage,
                authorId: user.id,
                authorName: user.name,
                authorAvatar: user.avatar,
                likes: 0,
                likedBy: [],
                comments: [],
                createdAt: new Date().toISOString()
            });
            savePosts(posts);
            document.getElementById('postInput').value = '';
            removeImage();
            loadProfile();
            loadUserPosts();
            showToast('Posted');
        }

        function deletePost(id) {
            if (confirm('Delete this post?')) {
                savePosts(getPosts().filter(p => p.id !== id));
                loadProfile();
                loadUserPosts();
            }
        }

        function toggleComments(postId) {
            document.getElementById('comments-' + postId).classList.toggle('hidden');
        }

        function addComment(postId) {
            const input = document.getElementById('comment-input-' + postId);
            const text = input.value.trim();
            if (!text) return;

            const user = getUser();
            const posts = getPosts();
            const idx = posts.findIndex(p => p.id === postId);
            if (idx === -1) return;

            if (!posts[idx].comments) posts[idx].comments = [];
            posts[idx].comments.push({
                id: Date.now().toString(),
                text,
                authorId: user.id,
                authorName: user.name,
                authorAvatar: user.avatar,
                createdAt: new Date().toISOString()
            });
            savePosts(posts);
            loadUserPosts();
            setTimeout(() => document.getElementById('comments-' + postId).classList.remove('hidden'), 50);
        }

        function openEditModal() {
            const user = getUser();
            document.getElementById('editName').value = user.name;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editBio').value = user.bio;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveProfile() {
            const user = getUser();
            user.name = document.getElementById('editName').value || user.name;
            user.username = document.getElementById('editUsername').value || user.username;
            user.bio = document.getElementById('editBio').value || user.bio;
            saveUser(user);

            const posts = getPosts();
            posts.forEach(p => {
                if (p.authorId === user.id) {
                    p.authorName = user.name;
                    p.authorAvatar = user.avatar;
                }
            });
            savePosts(posts);

            closeEditModal();
            loadProfile();
            loadUserPosts();
            loadSidebarInfo();
            showToast('Profile saved');
        }
    </script>
</body>

</html>